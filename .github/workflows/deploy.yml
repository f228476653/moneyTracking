name: Deploy to Cloud Run

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: moneytracking-472503
  SERVICE_NAME: money-tracking
  REGION: us-central1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Django checks
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
      run: |
        python manage.py check
        python manage.py check --deploy

    - name: Run unit tests
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
      run: |
        python manage.py test statements.tests --verbosity=2

    - name: Lint with flake8
      run: |
        pip install flake8
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  deploy:
    name: Deploy to Cloud Run
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Google Cloud Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy using Cloud Build
      run: |
        gcloud builds submit --config cloudbuild-simple.yaml

    - name: Run Database Migrations
      run: |
        MIGRATION_JOB="migrate-db-${{ github.sha }}"

        # Create migration job
        gcloud run jobs create $MIGRATION_JOB \
          --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest \
          --region ${{ env.REGION }} \
          --set-env-vars="SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }},DATABASE_URL=${{ secrets.DATABASE_URL }},DJANGO_SETTINGS_MODULE=bank_parser.settings,DEBUG=False" \
          --command="python" \
          --args="manage.py,migrate" \
          --max-retries=2 \
          --parallelism=1 \
          --task-timeout=300s \
          --quiet || echo "Job already exists"

        # Execute migration
        gcloud run jobs execute $MIGRATION_JOB \
          --region ${{ env.REGION }} \
          --wait

        # Clean up
        gcloud run jobs delete $MIGRATION_JOB \
          --region ${{ env.REGION }} \
          --quiet || true

    - name: Get Service URL
      id: service
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format='value(status.url)')
        echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT

    - name: Deployment Summary
      run: |
        echo "ğŸš€ Deployment Complete!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Service: ${{ env.SERVICE_NAME }}"
        echo "Region: ${{ env.REGION }}"
        echo "URL: ${{ steps.service.outputs.url }}"
        echo "Commit: ${{ github.sha }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Create deployment annotation
      run: |
        echo "::notice title=Deployment Complete::Your app is live at ${{ steps.service.outputs.url }}"
